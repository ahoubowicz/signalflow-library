DEFAULT_RESOLUTION = 60000
AUTO_RESOLVE_AFTER = duration('1d')


def get_group_by(use_location=False):
    if use_location is True:
        group_by = [
            'test_id',
            'test_type',
            'location_id',
        ]
    else:
        group_by = [
            'test_id',
            'test_type',
        ]
    return group_by


def merge_filters(filter_=None, exclude_errors=False):
    if exclude_errors is True:
        scope = filter_ and filter('failed', 'false')
    else:
        scope = filter_

    return scope


def annotate_stream(stream, label):
    return annotate(stream, label, {'sfui_streamType': 'signal'})


def annotate_fire_threshold(threshold_stream, label='fire_threshold', orientation=None):
    if orientation is not None:
        threshold_ui_config = '{"stream_' + orientation + \
                              '_ft": {"sfui_streamType":"threshold","sfui_state":"fire","sfui_orientation":"' + \
                              orientation + '"}}'
    else:
        threshold_ui_config = '{"stream_out_of_ft": {"sfui_streamType":"threshold","sfui_state":"fire"}}'
    return annotate(threshold_stream, label, {'sfui_config': threshold_ui_config})


def assert_threshold(fire_threshold, clear_threshold, orientation):
    if clear_threshold is None:
        return
    if orientation == 'above':
        assert fire_threshold >= clear_threshold, {
            'fire_threshold': fire_threshold, 'clear_threshold': clear_threshold,
            'sfui_errorKeys': ['fire_threshold', 'clear_threshold'],
            'sfui_errorTemplate': "{{{fire_threshold}}} must be greater than or equal to {{{clear_threshold}}}."}
    elif orientation == 'below':
        assert fire_threshold <= clear_threshold, {
            'fire_threshold': fire_threshold, 'clear_threshold': clear_threshold,
            'sfui_errorKeys': ['fire_threshold', 'clear_threshold'],
            'sfui_errorTemplate': '{{{fire_threshold}}} must be less than or equal to {{{clear_threshold}}}.'}
    else:
        assert 0 > 1, {
            'orientation': orientation,
            'sfui_errorKeys': ['orientation'],
            'sfui_errorTemplate': '{{{orientation}}} threshold orientation is not supported'
        }


def directional_condition(stream, fire_threshold_stream, orientation):
    if orientation == 'above':
        return when(stream > fire_threshold_stream)
    elif orientation == 'below':
        return when(stream < fire_threshold_stream)
    else:
        assert 0 > 1


def shift_resolution_condition(stream, fire_threshold_stream, orientation, shifts_num):
    if shifts_num < 1:
        return when(const(1) > 0)

    first_shift = stream - stream.delta()
    first_cond = directional_condition(first_shift, fire_threshold_stream, orientation)

    if shifts_num == 1:
        return first_cond
    elif shifts_num == 2:
        second_shift = first_shift - first_shift.delta()
        return first_cond and directional_condition(second_shift, fire_threshold_stream, orientation)
    else:
        assert 0 > 1

